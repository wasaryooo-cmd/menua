--[[  
ðŸ“¦ ESP with Menu (Offline Version, Fixed)
Modified by ChatGPT
Toggles now correctly enable/disable visuals in real-time
]]

--// ESP Library (Kiriot22 base, minimal)
local ESP = {
    Enabled = false,
    Boxes = false,
    Tracers = false,
    Names = false,
    TeamColor = true,
    Objects = {},
    Connections = {}
}

local cam = workspace.CurrentCamera
local rs = game:GetService("RunService")
local players = game:GetService("Players")
local localPlr = players.LocalPlayer

local function Draw(type)
    local obj = Drawing.new(type)
    return obj
end

-- Create ESP for a player
function ESP:Add(player)
    if player == localPlr then return end
    local box = {
        Name = player.Name,
        Player = player,
        Quad = Draw("Quad"),
        Line = Draw("Line"),
        Text = Draw("Text"),
    }
    box.Text.Center = true
    box.Text.Size = 13
    box.Text.Outline = true
    box.Text.Color = Color3.new(1,1,1)
    box.Line.Thickness = 1
    box.Line.Color = Color3.new(1,1,1)
    box.Line.Visible = false
    box.Text.Visible = false
    table.insert(self.Objects, box)
end

-- Update visuals each frame
rs.RenderStepped:Connect(function()
    for _,v in pairs(ESP.Objects) do
        local char = v.Player.Character
        if ESP.Enabled and char and char:FindFirstChild("HumanoidRootPart") then
            local root = char.HumanoidRootPart
            local pos, vis = cam:WorldToViewportPoint(root.Position)
            if vis then
                -- Names
                if ESP.Names then
                    v.Text.Visible = true
                    v.Text.Position = Vector2.new(pos.X, pos.Y - 25)
                    v.Text.Text = v.Player.Name
                    if ESP.TeamColor and v.Player.Team and v.Player.Team.TeamColor then
                        v.Text.Color = v.Player.Team.TeamColor.Color
                    else
                        v.Text.Color = Color3.new(1,1,1)
                    end
                else
                    v.Text.Visible = false
                end
                -- Tracers
                if ESP.Tracers then
                    v.Line.Visible = true
                    v.Line.From = Vector2.new(cam.ViewportSize.X/2, cam.ViewportSize.Y)
                    v.Line.To = Vector2.new(pos.X, pos.Y)
                    if ESP.TeamColor and v.Player.Team and v.Player.Team.TeamColor then
                        v.Line.Color = v.Player.Team.TeamColor.Color
                    else
                        v.Line.Color = Color3.new(1,1,1)
                    end
                else
                    v.Line.Visible = false
                end
            else
                v.Text.Visible = false
                v.Line.Visible = false
            end
        else
            v.Text.Visible = false
            v.Line.Visible = false
        end
    end
end)

-- Add existing + new players
for _,plr in pairs(players:GetPlayers()) do
    ESP:Add(plr)
end
players.PlayerAdded:Connect(function(plr)
    ESP:Add(plr)
end)

--// UI Menu
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ESP_Menu"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local Frame = Instance.new("Frame", ScreenGui)
Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
Frame.BackgroundTransparency = 0.3
Frame.Position = UDim2.new(0.02,0,0.25,0)
Frame.Size = UDim2.new(0,180,0,180)
Frame.Active = true
Frame.Draggable = true
Frame.BorderSizePixel = 0

local Title = Instance.new("TextLabel", Frame)
Title.Text = "ESP MENU"
Title.Size = UDim2.new(1,0,0,25)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

local function makeBtn(text, y, func)
    local b = Instance.new("TextButton", Frame)
    b.BackgroundColor3 = Color3.fromRGB(50,50,50)
    b.Size = UDim2.new(1,-10,0,30)
    b.Position = UDim2.new(0,5,0,y)
    b.TextColor3 = Color3.new(1,1,1)
    b.TextSize = 16
    b.Text = text
    b.MouseButton1Click:Connect(function()
        func(b)
    end)
    return b
end

-- Buttons with live toggle text updates
local espbtn = makeBtn("ESP: OFF", 30, function(btn)
    ESP.Enabled = not ESP.Enabled
    btn.Text = "ESP: " .. (ESP.Enabled and "ON" or "OFF")
    -- Hide visuals instantly when turning off
    if not ESP.Enabled then
        for _,v in pairs(ESP.Objects) do
            v.Text.Visible = false
            v.Line.Visible = false
        end
    end
end)

local namebtn = makeBtn("Names: OFF", 65, function(btn)
    ESP.Names = not ESP.Names
    btn.Text = "Names: " .. (ESP.Names and "ON" or "OFF")
end)

local tracerbtn = makeBtn("Tracers: OFF", 100, function(btn)
    ESP.Tracers = not ESP.Tracers
    btn.Text = "Tracers: " .. (ESP.Tracers and "ON" or "OFF")
end)

print("[âœ…] ESP Menu Loaded (Toggle Fixed Offline Version)")
